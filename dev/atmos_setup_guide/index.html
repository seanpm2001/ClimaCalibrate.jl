<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>ClimaAtmos Setup Guide · ClimaCalibrate.jl</title><meta name="title" content="ClimaAtmos Setup Guide · ClimaCalibrate.jl"/><meta property="og:title" content="ClimaAtmos Setup Guide · ClimaCalibrate.jl"/><meta property="twitter:title" content="ClimaAtmos Setup Guide · ClimaCalibrate.jl"/><meta name="description" content="Documentation for ClimaCalibrate.jl."/><meta property="og:description" content="Documentation for ClimaCalibrate.jl."/><meta property="twitter:description" content="Documentation for ClimaCalibrate.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">ClimaCalibrate.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../quickstart/">Getting Started</a></li><li class="is-active"><a class="tocitem" href>ClimaAtmos Setup Guide</a><ul class="internal"><li><a class="tocitem" href="#Summary"><span>Summary</span></a></li><li><a class="tocitem" href="#Atmos-Configuration-File"><span>Atmos Configuration File</span></a></li><li><a class="tocitem" href="#Restart-File-(optional)"><span>Restart File (optional)</span></a></li><li><a class="tocitem" href="#Prior-Distribution-File"><span>Prior Distribution File</span></a></li><li><a class="tocitem" href="#Observation-Map"><span>Observation Map</span></a></li><li><a class="tocitem" href="#Generating-Truth-Data"><span>Generating Truth Data</span></a></li><li><a class="tocitem" href="#EKP-Configuration"><span>EKP Configuration</span></a></li><li><a class="tocitem" href="#Plotting-Results"><span>Plotting Results</span></a></li></ul></li><li><a class="tocitem" href="../emulate_sample/">Emulate and Sample</a></li><li><a class="tocitem" href="../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>ClimaAtmos Setup Guide</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>ClimaAtmos Setup Guide</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaCalibrate.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaCalibrate.jl/blob/main/docs/src/atmos_setup_guide.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Experiment-Set-Up-Guide-for-ClimaAtmos"><a class="docs-heading-anchor" href="#Experiment-Set-Up-Guide-for-ClimaAtmos">Experiment Set Up Guide for ClimaAtmos</a><a id="Experiment-Set-Up-Guide-for-ClimaAtmos-1"></a><a class="docs-heading-anchor-permalink" href="#Experiment-Set-Up-Guide-for-ClimaAtmos" title="Permalink"></a></h1><p>Please read this entire guide before setting up an experiment. This guide assumes familiarity with ClimaAtmos and a basic understanding of Ensemble Kalman Inversion (EKI). Because moderate resolution ClimaAtmos runs need to be run with MPI and/or on GPU, this example demonstrates how to set up a perfect model example calibration (i.e., generating the synthetic &quot;true&quot; data with the same model that we are calibrating with towards a known set of parameters).</p><h2 id="Summary"><a class="docs-heading-anchor" href="#Summary">Summary</a><a id="Summary-1"></a><a class="docs-heading-anchor-permalink" href="#Summary" title="Permalink"></a></h2><p>For a perfect model scenario, observations are generated by running the model and then processing the diagnostic output through the constructed observation map.</p><p>To calibrate parameters, you need:</p><ul><li>Atmos model configuration</li><li>EKP configuration</li><li>Prior parameter distributions</li><li>Truth and noise data</li><li>Observation map script with a function <code>observation_map(iteration)</code></li></ul><p>These components are detailed in the guide below. Examples of all of these can also be found in ClimaAtmos in <code>calibration/experiments/sphere_held_suarez_rhoe_equilmoist</code></p><p>First, create a folder for your experiment with a descriptive name in the <code>calibration/experiments/</code> folder. All of the components described below will be stored in this folder.</p><h2 id="Atmos-Configuration-File"><a class="docs-heading-anchor" href="#Atmos-Configuration-File">Atmos Configuration File</a><a id="Atmos-Configuration-File-1"></a><a class="docs-heading-anchor-permalink" href="#Atmos-Configuration-File" title="Permalink"></a></h2><p>One ClimaAtmos configuration YAML file will be used to run all simulations in the calibration. The only changes between model runs are the parameters selected for calibration. This is a typical Atmos YAML file, but it must be named <code>model_config.yml</code>.</p><p>If your configuration requires a parameter TOML file, ensure that the <code>toml</code> entry in your configuration is an absolute path or a correctly configured relative path.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>When targeting a global or otherwise costly simulation, it may be worth it to optimize your timestep <code>dt</code> as well as your timestepping algorithm, <code>ode_algo</code>. Turning off default diagnostics can increase performance as well.</p></div></div><h2 id="Restart-File-(optional)"><a class="docs-heading-anchor" href="#Restart-File-(optional)">Restart File (optional)</a><a id="Restart-File-(optional)-1"></a><a class="docs-heading-anchor-permalink" href="#Restart-File-(optional)" title="Permalink"></a></h2><p>The restart file is a snapshot of the model state which will be used to spin-off all ensemble members&#39; forward model runs.</p><p>Once you have settled on a configuration, follow these steps to generate a restart file:</p><ol><li>Run ClimaAtmos with your configuration to determine the time it takes for the simulation to reach an equilibrium state.</li><li>Generate a restart file by setting <code>dt_save_state_to_disk</code> in the model configuration to the equilibrium timestamp.</li><li>Transfer the file to your experiment directory and enter the relative path into your atmosphere configuration file:</li></ol><pre><code class="nohighlight hljs">restart_file: experiments/experiment_name/restart_file.hdf5</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>A restarted simulation starts from the saved date of the restart file. A restart file saved at 200 days and a <code>t_end</code> of 201 days will only run for 1 simulated day:</p><pre><code class="nohighlight hljs">restart_file: experiments/experiment_name/day200.hdf5
t_end: 201 days</code></pre></div></div><h2 id="Prior-Distribution-File"><a class="docs-heading-anchor" href="#Prior-Distribution-File">Prior Distribution File</a><a id="Prior-Distribution-File-1"></a><a class="docs-heading-anchor-permalink" href="#Prior-Distribution-File" title="Permalink"></a></h2><p>First, create your TOML file in your experiment folder. For each calibrated parameter, create a prior distribution with the following format:</p><pre><code class="language-toml hljs">[name]
type = &quot;float&quot;
prior = &quot;constrained_gaussian(name, mean, stdev, upper_bound, lower_bound)&quot;</code></pre><p>Note that the prior distribution here is in constrained space.  When using other constructors are in unconstrained, such as <code>Parameterized(Normal(0,1))</code>, and need to be constrained by an additional field <code>constraint</code>, which constrains the distribution in parameter space.</p><p>Constraint constructors:</p><ul><li>Lower bound: <code>bounded_below(0)</code></li><li>Upper bound: <code>bounded_above(2)</code></li><li>Upper and lower bounds: <code>bounded(0, 2)</code></li></ul><div class="admonition is-info"><header class="admonition-header">Why two parameter spaces?</header><div class="admonition-body"><p>The calibration tools are effective when working with unconstrained parameters (<code>u</code>), whereas physical models typically require (partially-)bounded parameters (<code>φ</code>). To satisfy both conditions the <code>ParameterDistribution</code> object contains maps between these two spaces. The drawback is that the prior must be defined in the unconstrained space.</p></div></div><h2 id="Observation-Map"><a class="docs-heading-anchor" href="#Observation-Map">Observation Map</a><a id="Observation-Map-1"></a><a class="docs-heading-anchor-permalink" href="#Observation-Map" title="Permalink"></a></h2><p>The observation map is applied to process model output diagnostics into the exact observable used to fit to observations. In a perfect model setting it is used also to generate the observation.</p><p>These requirements arise from the update step, which runs the <code>observation_map</code> function. This function must load in model diagnostics for each ensemble member in the iteration and construct an array <code>arr = Array{Float64}(undef, dims..., ensemble_size)</code> such that <code>arr[:, i]</code> will return the i-th ensemble member&#39;s observation map output. Note this floating point precision is required for the EKI update step.</p><p>In the update step of EKI, the array will be saved in a JLD2 file named <code>G_ensemble.jld2</code> in the iteration folder of the output directory.</p><p>As an example, in <code>observation_map</code> function in the <code>sphere_held_suarez_rhoe_equilmoist</code> experiment, we have the following sequence:</p><p>First, construct the array to store the ensemble&#39;s observations. Then, for each ensemble member <code>m</code>:</p><ul><li>Load in the model diagnostic output, in this case 60-day air temperature averages.</li><li>Call <code>process_member_data(m)</code> and stores the result in the output array.</li></ul><p>Pseudocode for <code>observation_map(iteration)</code>:</p><pre><code class="language-julia hljs">function observation_map(iteration)
    # Get Configuration
    config_file = joinpath(&quot;calibration&quot;, &quot;sphere_held_suarez_rhoe_equilmoist&quot;)
    config = ExperimentConfig(config_file)
    ensemble_size = config.ensemble_size

    # Setup output array
    # dims = size of individual member observation map output
    dims = 1
    G_ensemble = Array{Float64}(undef, dims..., ensemble_size)

    for m in 1:ensemble_size
        ta = load_member_diagnostics(m)
        # Compute observation map for the member
        G_ensemble[:, m] = process_member_data(ta)
    end
    return G_ensemble
end</code></pre><p><code>process_member_data(m)</code> then does the following:</p><ol><li>Removes the first two samples to ensure an equilibrium state</li><li>Averages across latitude and longitude</li><li>Extracts the second height slice</li><li>Returns the third sample in an array</li></ol><p>Pseudocode for <code>process_member_data(m)</code>:</p><pre><code class="language-julia hljs">function process_member_data(ta; output_variance = false)
    # Cut off first two points to ensure equilibrium, grab second height slice
    ta_second_height = ta[3:size(ta)[1], :, :, 2]
    # Average over long and latitude
    area_avg_ta_second_height =
        longitudinal_avg(latitudinal_avg(ta_second_height))
    # Take the third sample
    observation = [area_avg_ta_second_height[3]]
    return observation
end</code></pre><p>If you are running a perfect-model experiment and generating truth data from ClimaAtmos itself, you may find it useful to create a kernel function to compute the observation map for each ensemble member. You can use this to run the default simulation&#39;s diagnostic output through the observation map and save the truth data and noise.</p><h2 id="Generating-Truth-Data"><a class="docs-heading-anchor" href="#Generating-Truth-Data">Generating Truth Data</a><a id="Generating-Truth-Data-1"></a><a class="docs-heading-anchor-permalink" href="#Generating-Truth-Data" title="Permalink"></a></h2><p>The truth data must be an array of observations with the same dimensions as an individual ensemble member&#39;s entry in the observation map (<code>arr[:, i]</code> from above).</p><p>The noise is the sample covariance of the truth data. The dimension of each truth data sample determines how many samples you need to generate. Covariance estimation techniques may be required for high dimensional truth data.</p><p>Save a single sample from the observations and the noise in separate JLD2 files. These will be read in when constructing the EKP object. For <code>sphere_held_suarez_rhoe_equilmoist</code>, these are saved as <code>obs_mean.jld2</code> and <code>obs_noise_cov.jld2</code> respectively. To inspect them, start <code>julia --project=experiments</code> and run:</p><pre><code class="language-julia hljs">import JLD2
experiment_path = joinpath(&quot;experiments&quot;, &quot;sphere_held_suarez_rhoe_equilmoist&quot;)
truth = JLD2.load_object(joinpath(experiment_path, &quot;obs_mean.jld2&quot;))
noise = JLD2.load_object(joinpath(experiment_path, &quot;obs_noise_cov.jld2&quot;))</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>For full reproducibility, create and store a script that generates the truth data. If running a perfect-model scenario, the script should run the model and use the resulting diagnostic output to generate the truth data.</p></div></div><h2 id="EKP-Configuration"><a class="docs-heading-anchor" href="#EKP-Configuration">EKP Configuration</a><a id="EKP-Configuration-1"></a><a class="docs-heading-anchor-permalink" href="#EKP-Configuration" title="Permalink"></a></h2><p>Your EKP configuration must supply the following:</p><ul><li><code>n_iterations</code>, the number of iterations to run</li><li><code>ensemble_size</code>, the ensemble size</li><li><code>prior</code>, the prior parameter distributions</li><li><code>observations</code>, the observational data</li><li><code>noise</code>, the covariance of the observational data</li><li><code>output_dir</code>, the folder where you want calibration data and logs to be output. This must be the same as the <code>output_dir</code> in the model configuration file.</li></ul><p>These can be turned into an <code>ExperimentConfig</code>, a convenience struct to use with the <code>calibrate</code> function:</p><pre><code class="nohighlight hljs">experiment_config = ExperimentConfig(; n_iterations, ensemble_size, prior, observations, noise, output_dir)

calibrate(experiment_config)</code></pre><p>For more information, see <code>ExperimentConfig</code> in the API reference.</p><p>These fields can also be placed into a YAML file and read into the struct via <code>ExperimentConfig(filepath)</code></p><p>Example YAML file:</p><pre><code class="nohighlight hljs">output_dir: output/sphere_held_suarez_rhoe_equilmoist
prior: prior.toml
ensemble_size: 10
n_iterations: 3
observations: obs_mean.jld2
noise: obs_noise_cov.jld2</code></pre><h2 id="Plotting-Results"><a class="docs-heading-anchor" href="#Plotting-Results">Plotting Results</a><a id="Plotting-Results-1"></a><a class="docs-heading-anchor-permalink" href="#Plotting-Results" title="Permalink"></a></h2><p>It may be useful to generate convergence plots to summarize your experiments. The <code>postprocessing.jl</code> file in <code>surface_fluxes_perfect_model</code> experiment provides a decent template.</p><p>Sample plots from <code>surface_fluxes_perfect_model</code>: <img src="../assets/sf_convergence_coefficient_a_m_businger.png" alt="Convergence Plot"/> <img src="../assets/sf_scatter_iter.png" alt="Scatter Plot"/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../quickstart/">« Getting Started</a><a class="docs-footer-nextpage" href="../emulate_sample/">Emulate and Sample »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.7.0 on <span class="colophon-date" title="Friday 25 October 2024 21:49">Friday 25 October 2024</span>. Using Julia version 1.10.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
